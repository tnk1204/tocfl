<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√în t·∫≠p T·ª´ v·ª±ng TOCFL A1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chosen Palette: Slate & Blue -->
    <!-- Application Structure Plan: The app is a single-page dashboard for vocabulary learning. The core structure features a control panel for filtering and initiating practice modes, and a main grid for vocabulary exploration. This update introduces a new 'Review Mode' alongside the existing 'Quiz Mode', both launched via modals. This dual-mode approach caters to different learning styles: active recall via quizzes and spaced repetition via focused review. The information architecture is designed for task-oriented learning (browse, search, quiz, review) rather than a static presentation. -->
    <!-- Visualization & Content Choices: Data is presented as interactive flashcards. Goal: Memorization. Method: Interactive Cards & Modals. Interaction: Flip cards, use text-to-speech, take quizzes, and use a focused review mode with self-assessment. Justification: These methods are based on proven learning techniques like active recall and spaced repetition, significantly boosting memory retention over passive reading. All elements are built with HTML/CSS. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body { font-family: 'Inter', sans-serif; }
        .flashcard { perspective: 1000px; }
        .flashcard-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; cursor: pointer; }
        .flashcard.is-flipped .flashcard-inner { transform: rotateY(180deg); }
        .flashcard-front, .flashcard-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 1rem; border-radius: 0.75rem; }
        .flashcard-back { transform: rotateY(180deg); }
        .speak-btn {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .speak-btn:hover { background: rgba(255, 255, 255, 0.4); }
        .modal-base { display: none; }
        .modal-base.active { display: flex; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">C√¥ng c·ª• √în t·∫≠p T·ª´ v·ª±ng TOCFL A1</h1>
            <p class="text-slate-600 mt-2">S√°ch "A Course in Contemporary Chinese" - B√†i 1 ƒë·∫øn 15</p>
        </header>

        <div class="sticky top-0 bg-slate-50/80 backdrop-blur-sm z-10 py-4 mb-6">
            <div class="flex flex-col md:flex-row gap-4 max-w-5xl mx-auto items-end">
                <div class="flex-grow w-full md:w-1/3">
                    <label for="lesson-filter" class="block text-sm font-medium text-slate-700 mb-1">L·ªçc</label>
                    <select id="lesson-filter" class="w-full p-3 bg-white border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                        <option value="all">T·∫•t c·∫£ b√†i h·ªçc</option>
                    </select>
                </div>
                <div class="flex-grow w-full md:w-1/3">
                     <label for="search-input" class="block text-sm font-medium text-slate-700 mb-1">T√¨m ki·∫øm</label>
                    <input type="text" id="search-input" placeholder="Nh·∫≠p t·ª´..." class="w-full p-3 bg-white border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                </div>
                <div class="w-full md:w-auto flex gap-2">
                    <button id="review-btn" class="flex-1 w-full bg-green-600 text-white font-semibold p-3 rounded-lg shadow-md hover:bg-green-700 transition flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>
                        √în t·∫≠p
                    </button>
                    <button id="practice-btn" class="flex-1 w-full bg-blue-600 text-white font-semibold p-3 rounded-lg shadow-md hover:bg-blue-700 transition flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v1.946l4.061 4.061a1 1 0 01-1.414 1.414l-4.5-4.5a1 1 0 011.653-1.653zM4.646 4.646a1 1 0 011.414 0L10 8.586l3.94-3.94a1 1 0 111.414 1.414L11.414 10l3.94 3.94a1 1 0 11-1.414 1.414L10 11.414l-3.94 3.94a1 1 0 01-1.414-1.414L8.586 10 4.646 6.06a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                        Luy·ªán t·∫≠p
                    </button>
                    <button id="daily-test-btn" class="flex-1 w-full bg-purple-600 text-white font-semibold p-3 rounded-lg shadow-md hover:bg-purple-700 transition flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" /></svg>
                        Ki·ªÉm tra h√†ng ng√†y
                    </button>
                </div>
            </div>
             <p id="word-count" class="text-center text-slate-500 mt-4 text-sm"></p>
        </div>

        <main id="vocab-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 md:gap-6">
            <!-- Vocabulary cards will be rendered here by JavaScript -->
        </main>
        
        <footer class="text-center mt-12 text-slate-500 text-sm">
            <p>Nh·∫•n v√†o th·∫ª ƒë·ªÉ l·∫≠t. Nh·∫•n üîä ƒë·ªÉ nghe ph√°t √¢m.</p>
        </footer>
    </div>
    
    <!-- Quiz Modal -->
    <div id="quiz-modal" class="modal-base fixed inset-0 bg-black bg-opacity-50 justify-center items-center z-50">
        <div class="bg-white rounded-lg shadow-2xl p-6 md:p-8 w-11/12 max-w-lg transform transition-all scale-95 opacity-0" id="quiz-modal-content">
             <div id="quiz-setup">
                <h2 class="text-2xl font-bold mb-4">Ch·∫ø ƒë·ªô Luy·ªán t·∫≠p</h2>
                <p class="text-slate-600 mb-6">Ch·ªçn h√¨nh th·ª©c v√† n·ªôi dung ƒë·ªÉ b·∫Øt ƒë·∫ßu b√†i ki·ªÉm tra.</p>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-slate-700 mb-2">H√¨nh th·ª©c</label>
                    <select id="quiz-type" class="w-full p-3 bg-white border border-slate-300 rounded-lg">
                        <option value="char-to-meaning">Ch·ªØ H√°n ‚Üí Nghƒ©a</option>
                        <option value="pinyin-to-meaning">Pinyin ‚Üí Nghƒ©a</option>
                        <option value="meaning-to-char">Nghƒ©a ‚Üí Ch·ªØ H√°n</option>
                        <option value="listen-to-meaning">Nghe ‚Üí Nghƒ©a</option>
                        <option value="daily-test">Ki·ªÉm tra h√†ng ng√†y (TOCFL A1)</option>
                    </select>
                </div>
                 <div class="mb-6">
                    <label class="block text-sm font-medium text-slate-700 mb-2">N·ªôi dung</label>
                    <select id="quiz-source" class="w-full p-3 bg-white border border-slate-300 rounded-lg">
                        <option value="current">T·ª´ ƒëang l·ªçc</option>
                        <option value="all">T·∫•t c·∫£ t·ª´ v·ª±ng</option>
                        <option value="need-review">T·ª´ c·∫ßn √¥n l·∫°i</option>
                    </select>
                </div>
                <div class="flex justify-end gap-4">
                    <button id="close-quiz-setup-btn" class="px-6 py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300 transition">H·ªßy</button>
                    <button id="start-quiz-btn" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">B·∫Øt ƒë·∫ßu</button>
                </div>
            </div>
            
            <div id="quiz-main" class="hidden">
                 <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Tr·∫Øc nghi·ªám</h2>
                    <p id="quiz-progress" class="text-slate-500"></p>
                 </div>
                 <div id="quiz-question-card" class="bg-slate-100 p-8 rounded-lg text-center mb-6 min-h-[120px] flex items-center justify-center">
                    <div>
                        <p id="quiz-question" class="text-4xl font-semibold"></p>
                        <p id="quiz-question-hint" class="text-slate-500 mt-2"></p>
                    </div>
                 </div>
                 <div id="quiz-options" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                 <div id="quiz-feedback" class="mt-4 text-center font-semibold h-6"></div>
            </div>

             <div id="quiz-results" class="hidden text-center">
                <h2 class="text-2xl font-bold mb-4">K·∫øt qu·∫£</h2>
                <p id="quiz-score" class="text-5xl font-bold text-blue-600 mb-4"></p>
                <div id="quiz-wrong-answers" class="max-h-60 overflow-y-auto my-4 text-left p-4 bg-slate-50 rounded-lg border"></div>
                <div class="flex flex-wrap justify-center gap-4">
                    <button id="quiz-review-wrong-btn" class="px-6 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transition hidden">√în l·∫°i c√¢u sai</button>
                    <button id="quiz-restart-btn" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">L√†m l·∫°i</button>
                    <button id="quiz-close-btn" class="px-6 py-3 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300 transition">ƒê√≥ng</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Review Modal -->
    <div id="review-modal" class="modal-base fixed inset-0 bg-slate-900 bg-opacity-80 justify-center items-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-2xl p-6 md:p-8 w-full max-w-2xl transform transition-all scale-95 opacity-0" id="review-modal-content">
             <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Ch·∫ø ƒë·ªô √în t·∫≠p Th√¥ng minh</h2>
                <button id="review-close-btn" class="text-slate-500 hover:text-slate-800 text-2xl leading-none">&times;</button>
             </div>
             <p id="review-progress" class="text-center text-slate-500 mb-4"></p>
             <div id="review-card-container" class="h-64">
                 <div class="flashcard h-full">
                    <div class="flashcard-inner">
                        <div id="review-card-front" class="flashcard-front bg-slate-100 shadow-md"></div>
                        <div id="review-card-back" class="flashcard-back bg-blue-600 text-white shadow-lg relative">
                            <p class="text-lg font-medium">${word.pinyin}</p>
                            <p class="mt-1 text-center">${word.meaning}</p>
                            <button class="speak-btn" data-text="${word.char}">üîä</button>
                            <button class="note-btn" data-char="${word.char}" style="position: absolute; bottom: 8px; left: 8px; background: rgba(255, 255, 255, 0.2); border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; transition: background 0.2s;">üìù</button>
                            <p class="note-text" style="font-size: 0.8rem; margin-top: 0.5rem; text-align: center;">${notes[word.char] || ''}</p>
                        </div>
                    </div>
                 </div>
             </div>
             <div id="speech-settings" class="mt-4 p-4 bg-slate-50 rounded-lg">
                <h3 class="text-lg font-semibold mb-2">C√†i ƒë·∫∑t ph√°t √¢m</h3>
                <div class="mb-2">
                    <label for="speech-rate" class="block text-sm font-medium text-slate-700 mb-1">T·ªëc ƒë·ªô ph√°t √¢m:</label>
                    <select id="speech-rate" class="w-full p-2 bg-white border border-slate-300 rounded-lg" onchange="updateSpeechSettings()">
                        <option value="0.7">Ch·∫≠m</option>
                        <option value="0.9" selected> B√¨nh th∆∞·ªùng</option>
                        <option value="1.1">Nhanh</option>
                    </select>
                </div>
                <div>
                    <label class="flex items-center text-sm font-medium text-slate-700">
                        <input type="checkbox" id="auto-play" class="mr-2" onchange="updateSpeechSettings()">
                        Ph√°t √¢m t·ª± ƒë·ªông khi l·∫≠t th·∫ª
                    </label>
                </div>
             </div>
             <div id="review-difficulty-buttons" class="mt-6 flex justify-around hidden">
                 <button data-difficulty="1" class="btn-difficulty border-2 border-transparent w-1/3 py-3 rounded-lg bg-red-500 text-white font-semibold hover:bg-red-600 transition">Kh√≥</button>
                 <button data-difficulty="2" class="btn-difficulty border-2 border-transparent w-1/3 py-3 mx-4 rounded-lg bg-yellow-500 text-white font-semibold hover:bg-yellow-600 transition">V·ª´a</button>
                 <button data-difficulty="3" class="btn-difficulty border-2 border-transparent w-1/3 py-3 rounded-lg bg-green-500 text-white font-semibold hover:bg-green-600 transition">D·ªÖ</button>
             </div>
        </div>
    </div>

    <!-- SCRIPT LOADING -->
    <!-- Load vocabulary data first -->
    <script src="vocabulary.js"></script>

    <!-- Then, load the main application logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Check if vocabData is loaded
            if (typeof vocabData === 'undefined') {
                console.error("L·ªói: D·ªØ li·ªáu t·ª´ v·ª±ng (vocabulary.js) ch∆∞a ƒë∆∞·ª£c t·∫£i.");
                alert("Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu t·ª´ v·ª±ng. Vui l√≤ng ki·ªÉm tra file vocabulary.js.");
                return;
            }

            let currentFilteredData = [];
            let currentQuiz = { questions: [], wrongAnswers: [], currentQuestionIndex: 0, score: 0, settings: {} };
            let reviewSession = { queue: [], currentWord: null };
            
            const grid = document.getElementById('vocab-grid');
            const lessonFilter = document.getElementById('lesson-filter');
            const searchInput = document.getElementById('search-input');
            const wordCountEl = document.getElementById('word-count');
            
            const practiceBtn = document.getElementById('practice-btn');
            const reviewBtn = document.getElementById('review-btn');
            
            const quizModal = document.getElementById('quiz-modal');
            const quizModalContent = document.getElementById('quiz-modal-content');
            const quizSetup = document.getElementById('quiz-setup');
            const quizMain = document.getElementById('quiz-main');
            const quizResults = document.getElementById('quiz-results');
            const closeQuizSetupBtn = document.getElementById('close-quiz-setup-btn');
            const startQuizBtn = document.getElementById('start-quiz-btn');
            const quizCloseBtn = document.getElementById('quiz-close-btn');
            const quizRestartBtn = document.getElementById('quiz-restart-btn');
            const quizReviewWrongBtn = document.getElementById('quiz-review-wrong-btn');
            
            const reviewModal = document.getElementById('review-modal');
            const reviewModalContent = document.getElementById('review-modal-content');
            const reviewCloseBtn = document.getElementById('review-close-btn');
            const reviewCardContainer = document.getElementById('review-card-container');
            const reviewDifficultyButtons = document.getElementById('review-difficulty-buttons');

            let speechRate = 0.9;
            let autoPlayOnFlip = false;
            let notes = JSON.parse(localStorage.getItem('vocabNotes')) || {};
            let progress = JSON.parse(localStorage.getItem('vocabProgress')) || {};

            function updateSpeechSettings() {
                speechRate = parseFloat(document.getElementById('speech-rate').value);
                autoPlayOnFlip = document.getElementById('auto-play').checked;
            }

            function saveNotes() {
                localStorage.setItem('vocabNotes', JSON.stringify(notes));
            }

            function saveProgress() {
                localStorage.setItem('vocabProgress', JSON.stringify(progress));
            }

            function updateWordProgress(char, status, difficulty) {
                if (!progress[char]) {
                    progress[char] = { status: status, lastReviewed: new Date().toISOString(), interval: 0, difficulty: difficulty };
                } else {
                    progress[char].status = status;
                    progress[char].lastReviewed = new Date().toISOString();
                    progress[char].difficulty = difficulty;
                    if (status === 'known') {
                        progress[char].interval = calculateInterval(progress[char].interval, difficulty);
                    } else {
                        progress[char].interval = 0;
                    }
                }
                saveProgress();
            }

            function calculateInterval(currentInterval, difficulty) {
                const baseIntervals = { '1': 1, '2': 3, '3': 6 };
                const multiplier = difficulty === '1' ? 0.5 : difficulty === '2' ? 1 : 1.5;
                return currentInterval === 0 ? baseIntervals[difficulty] : Math.round(currentInterval * multiplier);
            }

            function getWordsToReview() {
                const now = new Date();
                return Object.keys(progress).filter(char => {
                    const wordProgress = progress[char];
                    const lastReviewed = new Date(wordProgress.lastReviewed);
                    const daysSinceReview = (now - lastReviewed) / (1000 * 60 * 60 * 24);
                    return daysSinceReview >= wordProgress.interval && wordProgress.status !== 'mastered';
                });
            }

            // Populate lesson filter
            const lessons = [...new Set(vocabData.map(item => item.lesson))];
            lessons.sort((a, b) => a - b).forEach(lesson => {
                const option = document.createElement('option');
                option.value = lesson;
                option.textContent = `B√†i ${lesson}`;
                lessonFilter.appendChild(option);
            });

            function speak(text) {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'zh-CN';
                    utterance.rate = speechRate;
                    window.speechSynthesis.speak(utterance);
                } else {
                    alert('Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ ch·ª©c nƒÉng ph√°t √¢m.');
                }
            }

            const renderCards = (data) => {
                grid.innerHTML = '';
                if (data.length === 0) {
                    grid.innerHTML = `<p class="col-span-full text-center text-slate-500">Kh√¥ng t√¨m th·∫•y t·ª´ v·ª±ng n√†o.</p>`;
                    wordCountEl.textContent = '0 t·ª´ v·ª±ng';
                    return;
                }
                
                wordCountEl.textContent = `${data.length} t·ª´ v·ª±ng`;
                currentFilteredData = data;

                data.forEach(word => {
                    const cardWrapper = document.createElement('div');
                    cardWrapper.className = 'flashcard h-32';
                    
                    const inner = document.createElement('div');
                    inner.className = 'flashcard-inner';
                    inner.addEventListener('click', () => cardWrapper.classList.toggle('is-flipped'));

                    const front = document.createElement('div');
                    front.className = 'flashcard-front bg-white shadow-lg border border-slate-200';
                    let statusIndicator = '';
                    if (progress[word.char]) {
                        statusIndicator = progress[word.char].status === 'known' ? '‚úÖ' : progress[word.char].status === 'learning' ? 'üìö' : '‚ùå';
                    }
                    front.innerHTML = `<span class="text-3xl font-semibold text-slate-800 text-center">${word.char} ${statusIndicator}</span>`;

                    const back = document.createElement('div');
                    back.className = 'flashcard-back bg-blue-600 text-white shadow-lg relative';
                    back.innerHTML = `
                        <p class="text-lg font-medium">${word.pinyin}</p>
                        <p class="mt-1 text-center">${word.meaning}</p>
                        <button class="speak-btn" data-text="${word.char}">üîä</button>
                        <button class="note-btn" data-char="${word.char}" style="position: absolute; bottom: 8px; left: 8px; background: rgba(255, 255, 255, 0.2); border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; transition: background 0.2s;">üìù</button>
                        <p class="note-text" style="font-size: 0.8rem; margin-top: 0.5rem; text-align: center;">${notes[word.char] || ''}</p>
                    `;
                    
                    inner.appendChild(front);
                    inner.appendChild(back);
                    cardWrapper.appendChild(inner);
                    
                    grid.appendChild(cardWrapper);
                });
            }
            
            grid.addEventListener('click', function(e) {
                if (e.target.classList.contains('speak-btn')) {
                    e.stopPropagation();
                    const textToSpeak = e.target.getAttribute('data-text');
                    speak(textToSpeak);
                } else if (e.target.classList.contains('note-btn')) {
                    e.stopPropagation();
                    const char = e.target.getAttribute('data-char');
                    const note = prompt('Nh·∫≠p ghi ch√∫ cho t·ª´ ' + char + ':', notes[char] || '');
                    if (note !== null) {
                        notes[char] = note;
                        saveNotes();
                        const card = e.target.closest('.flashcard');
                        const noteTextEl = card.querySelector('.note-text');
                        noteTextEl.textContent = note;
                        noteTextEl.style.display = note ? 'block' : 'none';
                    }
                }
            });

            const getFilteredData = () => {
                 const selectedLesson = lessonFilter.value;
                 const searchTerm = searchInput.value.toLowerCase();
                 let filteredData = vocabData;

                 if (selectedLesson !== 'all') {
                     filteredData = filteredData.filter(word => word.lesson == selectedLesson);
                 }
                
                 if (searchTerm) {
                     filteredData = filteredData.filter(word => 
                         word.char.toLowerCase().includes(searchTerm) ||
                         word.pinyin.toLowerCase().includes(searchTerm) ||
                         word.meaning.toLowerCase().includes(searchTerm)
                     );
                 }
                 return filteredData;
            }

            const filterAndRender = () => {
                const data = getFilteredData();
                renderCards(data);
            }

            function showModal(modal, content) {
                modal.classList.add('active');
                setTimeout(() => {
                    content.classList.remove('scale-95', 'opacity-0');
                }, 10);
            }

            function hideModal(modal, content) {
                 content.classList.add('scale-95', 'opacity-0');
                 setTimeout(() => {
                    modal.classList.remove('active');
                    quizSetup.style.display = 'block';
                    quizMain.style.display = 'none';
                    quizResults.style.display = 'none';
                 }, 300);
            }
            
            function setupQuiz() {
                const quizType = document.getElementById('quiz-type').value;
                const quizSource = document.getElementById('quiz-source').value;
                let sourceData;

                if (quizSource === 'current') {
                    sourceData = getFilteredData();
                } else if (quizSource === 'need-review') {
                    const wordsToReview = getWordsToReview();
                    sourceData = vocabData.filter(word => wordsToReview.includes(word.char));
                    if (sourceData.length < 4) {
                        sourceData = vocabData;
                        alert('Kh√¥ng ƒë·ªß t·ª´ c·∫ßn √¥n l·∫°i. S·ª≠ d·ª•ng t·∫•t c·∫£ t·ª´ v·ª±ng ƒë·ªÉ ki·ªÉm tra.');
                    }
                } else {
                    sourceData = vocabData;
                }

                if (sourceData.length < 4) {
                    alert('C·∫ßn √≠t nh·∫•t 4 t·ª´ trong danh s√°ch ƒë√£ ch·ªçn ƒë·ªÉ t·∫°o b√†i ki·ªÉm tra.');
                    return;
                }

                currentQuiz.settings.type = quizType;
                if (quizType === 'daily-test') {
                    currentQuiz.questions = [...sourceData].sort(() => 0.5 - Math.random()).slice(0, 20);
                } else {
                    currentQuiz.questions = [...sourceData].sort(() => 0.5 - Math.random()).slice(0, 10);
                }
                currentQuiz.currentQuestionIndex = 0;
                currentQuiz.score = 0;
                currentQuiz.wrongAnswers = [];

                quizSetup.style.display = 'none';
                quizResults.style.display = 'none';
                quizMain.style.display = 'block';
                displayQuizQuestion();
            }

            function displayQuizQuestion() {
                if (currentQuiz.currentQuestionIndex >= currentQuiz.questions.length) {
                    showQuizResults();
                    return;
                }

                const questionEl = document.getElementById('quiz-question');
                const hintEl = document.getElementById('quiz-question-hint');
                const optionsEl = document.getElementById('quiz-options');
                const progressEl = document.getElementById('quiz-progress');
                const feedbackEl = document.getElementById('quiz-feedback');

                feedbackEl.textContent = '';
                optionsEl.innerHTML = '';
                
                progressEl.textContent = `C√¢u ${currentQuiz.currentQuestionIndex + 1} / ${currentQuiz.questions.length}`;
                const currentWord = currentQuiz.questions[currentQuiz.currentQuestionIndex];
                let questionText, questionHint = '', answerKey, optionKey;

                if (currentQuiz.settings.type === 'char-to-meaning') {
                    questionText = currentWord.char;
                    questionHint = currentWord.pinyin;
                    answerKey = 'meaning';
                    optionKey = 'meaning';
                } else if (currentQuiz.settings.type === 'pinyin-to-meaning') {
                    questionText = currentWord.pinyin;
                    questionHint = `(G·ª£i √Ω: ${currentWord.char})`;
                    answerKey = 'meaning';
                    optionKey = 'meaning';
                } else if (currentQuiz.settings.type === 'listen-to-meaning') {
                    questionText = 'Nghe v√† ch·ªçn nghƒ©a ƒë√∫ng';
                    questionHint = '';
                    answerKey = 'meaning';
                    optionKey = 'meaning';
                    speak(currentWord.char);
                } else if (currentQuiz.settings.type === 'daily-test') {
                    const types = ['char-to-meaning', 'pinyin-to-meaning', 'listen-to-meaning', 'meaning-to-char'];
                    const randomType = types[Math.floor(Math.random() * types.length)];
                    if (randomType === 'char-to-meaning') {
                        questionText = currentWord.char;
                        questionHint = currentWord.pinyin;
                        answerKey = 'meaning';
                        optionKey = 'meaning';
                    } else if (randomType === 'pinyin-to-meaning') {
                        questionText = currentWord.pinyin;
                        questionHint = `(G·ª£i √Ω: ${currentWord.char})`;
                        answerKey = 'meaning';
                        optionKey = 'meaning';
                    } else if (randomType === 'listen-to-meaning') {
                        questionText = 'Nghe v√† ch·ªçn nghƒ©a ƒë√∫ng';
                        questionHint = '';
                        answerKey = 'meaning';
                        optionKey = 'meaning';
                        speak(currentWord.char);
                    } else {
                        questionText = currentWord.meaning;
                        questionHint = `(Pinyin: ${currentWord.pinyin})`;
                        answerKey = 'char';
                        optionKey = 'char';
                    }
                    currentQuiz.settings.currentType = randomType;
                } else { // meaning-to-char
                    questionText = currentWord.meaning;
                    questionHint = `(Pinyin: ${currentWord.pinyin})`;
                    answerKey = 'char';
                    optionKey = 'char';
                }

                questionEl.textContent = questionText;
                hintEl.textContent = questionHint;

                const options = [currentWord];
                let allPossibleOptions = vocabData.filter(w => w.char !== currentWord.char);
                while(options.length < 4) {
                    const randomWord = allPossibleOptions[Math.floor(Math.random() * allPossibleOptions.length)];
                    if (!options.some(opt => opt[optionKey] === randomWord[optionKey])) {
                        options.push(randomWord);
                    }
                }

                options.sort(() => 0.5 - Math.random()).forEach(opt => {
                    const button = document.createElement('button');
                    button.className = 'w-full text-left p-4 bg-white border border-slate-300 rounded-lg hover:bg-slate-100 transition';
                    button.innerHTML = `<span class="font-semibold text-lg">${opt[optionKey]}</span>`;
                    button.onclick = () => checkQuizAnswer(opt === currentWord, currentWord, opt[optionKey]);
                    optionsEl.appendChild(button);
                });
            }

            function checkQuizAnswer(isCorrect, correctWord, chosenAnswer) {
                const feedbackEl = document.getElementById('quiz-feedback');
                const options = document.querySelectorAll('#quiz-options button');
                options.forEach(btn => btn.disabled = true);

                 if(isCorrect) {
                     currentQuiz.score++;
                     feedbackEl.textContent = 'Ch√≠nh x√°c!';
                     feedbackEl.className = 'mt-4 text-center font-semibold text-green-600';
                 } else {
                     feedbackEl.textContent = `Sai r·ªìi! ƒê√°p √°n ƒë√∫ng l√† "${correctWord[currentQuiz.settings.type.split('-')[1] === 'meaning' ? 'meaning' : 'char']}"`;
                     feedbackEl.className = 'mt-4 text-center font-semibold text-red-600';
                     currentQuiz.wrongAnswers.push({ question: correctWord, chosen: chosenAnswer });
                 }

                 currentQuiz.currentQuestionIndex++;
                 setTimeout(displayQuizQuestion, 2000);
            }

            function showQuizResults() {
                quizMain.style.display = 'none';
                quizResults.style.display = 'block';
                document.getElementById('quiz-score').textContent = `${currentQuiz.score} / ${currentQuiz.questions.length}`;
                
                const wrongAnswersEl = document.getElementById('quiz-wrong-answers');
                wrongAnswersEl.innerHTML = '';

                if (currentQuiz.wrongAnswers.length > 0) {
                    quizReviewWrongBtn.style.display = 'inline-flex';
                    let wrongHtml = '<h4 class="font-bold mb-2">C√°c c√¢u tr·∫£ l·ªùi sai:</h4><ul>';
                    currentQuiz.wrongAnswers.forEach(item => {
                        const q = item.question;
                        wrongHtml += `<li class="mb-2 p-2 bg-red-50 rounded-md">
                            <span class="font-medium">${q.char} (${q.pinyin})</span>: ${q.meaning}. <br/>
                            <span class="text-sm text-red-700">B·∫°n ƒë√£ ch·ªçn: "${item.chosen}"</span>
                        </li>`;
                    });
                    wrongHtml += '</ul>';
                    wrongAnswersEl.innerHTML = wrongHtml;
                } else {
                    quizReviewWrongBtn.style.display = 'none';
                    wrongAnswersEl.innerHTML = '<p class="text-green-600">Tuy·ªát v·ªùi! B·∫°n ƒë√£ tr·∫£ l·ªùi ƒë√∫ng t·∫•t c·∫£ c√°c c√¢u h·ªèi.</p>';
                }
            }
            
            practiceBtn.addEventListener('click', () => showModal(quizModal, quizModalContent));
            closeQuizSetupBtn.addEventListener('click', () => hideModal(quizModal, quizModalContent));
            startQuizBtn.addEventListener('click', setupQuiz);
            quizCloseBtn.addEventListener('click', () => hideModal(quizModal, quizModalContent));
            quizRestartBtn.addEventListener('click', () => {
                quizResults.style.display = 'none';
                quizSetup.style.display = 'block';
            });
            quizReviewWrongBtn.addEventListener('click', () => {
                currentQuiz.questions = currentQuiz.wrongAnswers.map(item => item.question);
                currentQuiz.currentQuestionIndex = 0;
                currentQuiz.score = 0;
                currentQuiz.wrongAnswers = [];
                quizResults.style.display = 'none';
                quizMain.style.display = 'block';
                displayQuizQuestion();
            });
            
            reviewBtn.addEventListener('click', () => {
                let sourceData = getFilteredData();
                const wordsToReview = getWordsToReview();
                if (sourceData.length === 0 && wordsToReview.length === 0) {
                    alert('H√£y ch·ªçn m·ªôt b·ªô t·ª´ ƒë·ªÉ √¥n t·∫≠p ho·∫∑c ki·ªÉm tra c√°c t·ª´ c·∫ßn √¥n l·∫°i.');
                    return;
                }
                if (wordsToReview.length > 0) {
                    reviewSession.queue = vocabData.filter(word => wordsToReview.includes(word.char));
                } else {
                    reviewSession.queue = [...sourceData].sort(() => 0.5 - Math.random());
                }
                startReviewSession();
            });

            function startReviewSession() {
                reviewDifficultyButtons.classList.add('hidden');
                reviewCardContainer.querySelector('.flashcard').classList.remove('is-flipped');
                showModal(reviewModal, reviewModalContent);
                nextReviewWord();
            }

            function nextReviewWord() {
                 if(reviewSession.queue.length === 0) {
                    alert('Ho√†n th√†nh phi√™n √¥n t·∫≠p!');
                    hideModal(reviewModal, reviewModalContent);
                    return;
                 }
                 document.getElementById('review-progress').textContent = `C√≤n l·∫°i: ${reviewSession.queue.length} t·ª´`;
                 reviewDifficultyButtons.classList.add('hidden');
                 reviewCardContainer.querySelector('.flashcard').classList.remove('is-flipped');

                 reviewSession.currentWord = reviewSession.queue.shift();
                 const word = reviewSession.currentWord;
                 document.getElementById('review-card-front').innerHTML = `<span class="text-5xl font-semibold">${word.char}</span>`;
                 document.getElementById('review-card-back').innerHTML = `
                        <p class="text-3xl font-semibold">${word.char}</p>
                        <p class="text-xl mt-2">${word.pinyin}</p>
                        <p class="mt-2 text-lg text-center">${word.meaning}</p>
                 `;
            }

            reviewCardContainer.addEventListener('click', () => {
                reviewCardContainer.querySelector('.flashcard').classList.add('is-flipped');
                reviewDifficultyButtons.classList.remove('hidden');
                if (autoPlayOnFlip && reviewSession.currentWord) {
                    speak(reviewSession.currentWord.char);
                }
            });
            
            reviewDifficultyButtons.addEventListener('click', (e) => {
                if(e.target.matches('.btn-difficulty')) {
                    const difficulty = parseInt(e.target.dataset.difficulty);
                    const status = difficulty === 3 ? 'known' : difficulty === 2 ? 'learning' : 'unknown';
                    updateWordProgress(reviewSession.currentWord.char, status, difficulty.toString());
                    nextReviewWord();
                }
            });

            reviewCloseBtn.addEventListener('click', () => hideModal(reviewModal, reviewModalContent));
            
            // Initial Setup
            lessonFilter.addEventListener('change', filterAndRender);
            searchInput.addEventListener('input', filterAndRender);
            filterAndRender();

            const dailyTestBtn = document.getElementById('daily-test-btn');

            dailyTestBtn.addEventListener('click', () => {
                document.getElementById('quiz-type').value = 'daily-test';
                document.getElementById('quiz-source').value = 'need-review';
                showModal(quizModal, quizModalContent);
            });
        });
    </script>
</body>
</html>
